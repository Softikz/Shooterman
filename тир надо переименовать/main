import pygame as pg
import sys
import random
import math
from pygame.locals import *

# Инициализация Pygame
pg.init()
pg.mixer.init()

# Звуки
shot_sound = pg.mixer.Sound("shot.wav")
explosion_sound = pg.mixer.Sound("explosion.wav")
boom_sound = pg.mixer.Sound('awp-sound.mp3')
reload_sound = pg.mixer.Sound("reload.wav")
minigan_sound = pg.mixer.Sound('strelbaisminigana.wav')

# Константы
WIDTH = 800
HEIGHT = 600
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
RED = (255, 0, 0)
GREEN = (0, 255, 0)
BLUE = (0, 0, 255)
GRAY = (100, 100, 100)
YELLOW = (255, 255, 0)
RELOAD_TIME = 2000

# Состояния игры
MENU = 0
LEVEL1 = 1
LEVEL2 = 2
SHOP = 3
DUEL = 4

screen = pg.display.set_mode((WIDTH, HEIGHT))
pg.display.set_caption("Тир")
clock = pg.time.Clock()

# Глобальные переменные
global_coins = 0
game_state = MENU

# Загрузка изображений
background_img = pg.image.load("background.png").convert_alpha()
player_img = pg.image.load("player.png").convert_alpha()
weapon_img = pg.image.load("weapon.png").convert_alpha()
bullet_img = pg.image.load("bullet.png").convert_alpha()
target_img = pg.image.load("target.png").convert_alpha()
target_hit_img = pg.image.load("target_hit.png").convert_alpha()
buy_button_img = pg.image.load("buy_button.png").convert_alpha()
barrier_img = pg.image.load("barrier.png").convert_alpha()
shop_img = pg.image.load("shop.png").convert_alpha()
rpg_img = pg.image.load("rpg.png").convert_alpha()
minigun_img = pg.image.load("minigun.png").convert_alpha()
sniper_img = pg.image.load("sniper.png").convert_alpha()
explosion_img = pg.image.load("explosion.png").convert_alpha()


class Button:
    def __init__(self, image, pos, text="", font_size=30, text_color=WHITE):
        self.image = image
        self.rect = image.get_rect()
        self.rect.topleft = pos
        self.text = text
        self.font_size = font_size
        self.text_color = text_color
        self.font = pg.font.SysFont(None, font_size)
        self.update_text()

    def update_text(self):
        while True:
            text_surf = self.font.render(self.text, True, self.text_color)
            if text_surf.get_width() <= self.rect.width - 40:
                break
            self.font_size -= 1
            self.font = pg.font.SysFont(None, self.font_size)
        self.text_surf = text_surf
        self.text_rect = text_surf.get_rect(center=self.rect.center)

    def is_clicked(self, pos):
        return self.rect.collidepoint(pos)

    def draw(self, surface):
        surface.blit(self.image, self.rect)
        if self.text:
            surface.blit(self.text_surf, self.text_rect)


class Weapon(pg.sprite.Sprite):
    def __init__(self, player, weapon_type, all_sprites):
        super().__init__()
        self.player = player
        self.weapon_type = weapon_type
        self.all_sprites = all_sprites

        if weapon_type == "pistol":
            self.image = weapon_img
        elif weapon_type == "rpg":
            self.image = rpg_img
        elif weapon_type == "minigun":
            self.image = minigun_img
        elif weapon_type == "sniper":
            self.image = sniper_img

        self.original_image = self.image.copy()
        self.rect = self.image.get_rect()
        self.angle = 0
        self.offset = (30, 10)

        if self.all_sprites:
            self.all_sprites.add(self)

    def update(self):
        mouse_pos = pg.mouse.get_pos()
        dx = mouse_pos[0] - self.player.rect.centerx
        dy = mouse_pos[1] - self.player.rect.centery
        self.angle = math.degrees(math.atan2(-dy, dx))

        self.image = pg.transform.rotate(self.original_image, self.angle)
        self.rect = self.image.get_rect(center=self.calculate_position())

    def get_muzzle_position(self):
        angle_rad = math.radians(self.angle)
        muzzle_distance = 25
        muzzle_x = self.rect.centerx + math.cos(angle_rad) * muzzle_distance
        muzzle_y = self.rect.centery - math.sin(angle_rad) * muzzle_distance
        return (muzzle_x, muzzle_y)

    def calculate_position(self):
        angle_rad = math.radians(self.angle)
        offset_x = self.offset[0] * math.cos(angle_rad)
        offset_y = self.offset[1] * math.sin(angle_rad)
        return (
            self.player.rect.centerx + offset_x,
            self.player.rect.centery - offset_y
        )

    def draw(self, surface):
        surface.blit(self.image, self.rect)


class Bullet(pg.sprite.Sprite):
    def __init__(self, x, y, angle, weapon_type="pistol"):
        super().__init__()
        self.weapon_type = weapon_type
        self.image = bullet_img
        self.rect = self.image.get_rect(center=(x, y))
        self.angle = angle
        self.image = pg.transform.rotate(self.image, angle)
        self.mask = pg.mask.from_surface(self.image)

        if weapon_type == "pistol":
            self.speed = 10
            self.damage = 1
        elif weapon_type == "minigun":
            self.speed = 15
            self.damage = 1
        elif weapon_type == "sniper":
            self.speed = 30
            self.damage = 2

        angle_rad = math.radians(angle)
        self.velocity = pg.math.Vector2()
        self.velocity.x = math.cos(angle_rad) * self.speed
        self.velocity.y = -math.sin(angle_rad) * self.speed

    def update(self):
        self.rect.centerx += int(self.velocity.x)
        self.rect.centery += int(self.velocity.y)

        if (self.rect.right < 0 or self.rect.left > WIDTH or
                self.rect.bottom < 0 or self.rect.top > HEIGHT):
            self.kill()


class RPGBullet(pg.sprite.Sprite):
    def __init__(self, x, y, angle):
        super().__init__()
        self.image = bullet_img
        self.rect = self.image.get_rect(center=(x, y))
        self.angle = angle
        self.speed = 8
        self.explosion_radius = 150
        self.exploded = False
        self.explosion_time = 0
        self.damage = 3
        self.mask = pg.mask.from_surface(self.image)

        angle_rad = math.radians(angle)
        self.velocity = pg.math.Vector2()
        self.velocity.x = math.cos(angle_rad) * self.speed
        self.velocity.y = -math.sin(angle_rad) * self.speed

    def update(self):
        if not self.exploded:
            self.rect.centerx += int(self.velocity.x)
            self.rect.centery += int(self.velocity.y)
            if (self.rect.right < 0 or self.rect.left > WIDTH or
                    self.rect.bottom < 0 or self.rect.top > HEIGHT):
                self.explode()
        else:
            if pg.time.get_ticks() - self.explosion_time > 500:
                self.kill()

    def explode(self):
        if not self.exploded:
            self.exploded = True
            self.explosion_time = pg.time.get_ticks()
            self.image = explosion_img
            self.rect = self.image.get_rect(center=self.rect.center)
            explosion_sound.play()


class Target(pg.sprite.Sprite):
    def __init__(self, level=1):
        super().__init__()
        self.image = target_img
        self.rect = self.image.get_rect()
        self.mask = pg.mask.from_surface(self.image)
        self.health = 2
        self.level = level

        if level == 1:
            self.rect.x = random.randint(int(WIDTH * 0.3), WIDTH - self.rect.width)
            self.rect.y = random.randint(50, HEIGHT - 50)
            self.speed = random.uniform(1, 3)
            self.direction = random.choice([-1, 1])
            self.min_y = random.randint(50, HEIGHT // 2)
            self.max_y = random.randint(self.min_y + 100, HEIGHT - 50)
        else:
            self.rect.x = random.randint(int(WIDTH * 0.3), WIDTH - self.rect.width)
            self.rect.y = random.randint(50, HEIGHT - 50)
            self.speed = 0
            self.lifetime = 2000
            self.spawn_time = pg.time.get_ticks()

    def hit(self, damage):
        self.health -= damage
        if self.health <= 2:
            self.image = target_hit_img
        if self.health <= 0:
            return True
        return False

    def update(self):
        if hasattr(self, 'lifetime'):
            if pg.time.get_ticks() - self.spawn_time > self.lifetime:
                self.kill()
        else:
            self.rect.y += self.speed * self.direction
            if self.rect.top < self.min_y:
                self.rect.top = self.min_y
                self.direction *= -1
            elif self.rect.bottom > self.max_y:
                self.rect.bottom = self.max_y
                self.direction *= -1


class Player(pg.sprite.Sprite):
    def __init__(self, coins=0, all_sprites=None):
        super().__init__()
        self.all_sprites = all_sprites
        self.image = player_img
        self.rect = self.image.get_rect()
        self.rect.centerx = 100
        self.rect.centery = HEIGHT // 2
        self.speed = 5
        self.weapon = Weapon(self, "pistol", all_sprites)
        self.magazines = 5
        self.bullets_in_magazine = 10
        self.reloading = False
        self.reload_start_time = 0
        self.coins = coins
        self.barrier = None
        self.current_weapon = "pistol"
        self.minigun_ammo = 0
        self.sniper_ammo = 0
        self.rpg_ammo = 0
        self.minigun_firing = False
        self.last_shot_time = 0
        self.minigun_fire_rate = 100

    def update(self):
        keys = pg.key.get_pressed()
        if keys[K_w] and self.rect.top > 0:
            self.rect.y -= self.speed
        if keys[K_s] and self.rect.bottom < HEIGHT:
            self.rect.y += self.speed
        if keys[K_a] and self.rect.left > 0:
            self.rect.x -= self.speed
        if keys[K_d] and self.rect.right < (self.barrier.rect.left if self.barrier else WIDTH):
            self.rect.x += self.speed
        self.weapon.update()

        if self.reloading:
            current_time = pg.time.get_ticks()
            if current_time - self.reload_start_time >= RELOAD_TIME:
                self.reloading = False
                if self.current_weapon == "pistol":
                    self.bullets_in_magazine = 10
                elif self.current_weapon == "minigun":
                    self.bullets_in_magazine = 50
                elif self.current_weapon == "sniper":
                    self.bullets_in_magazine = 3
                elif self.current_weapon == "rpg":
                    self.bullets_in_magazine = 1

        if (self.current_weapon == "minigun" and
                self.minigun_firing and
                pg.time.get_ticks() - self.last_shot_time > self.minigun_fire_rate and
                self.bullets_in_magazine > 0 and not self.reloading):
            self.bullets_in_magazine -= 1
            bullet_pos = self.weapon.get_muzzle_position()
            bullet = Bullet(bullet_pos[0], bullet_pos[1], self.weapon.angle + random.uniform(-5, 5), "minigun")
            self.last_shot_time = pg.time.get_ticks()
            return bullet
        return None

    def shoot(self):
        if self.bullets_in_magazine > 0 and not self.reloading:
            self.bullets_in_magazine -= 1
            bullet_pos = self.weapon.get_muzzle_position()
            if self.current_weapon == 'pistol':
                shot_sound.play()
                return Bullet(bullet_pos[0], bullet_pos[1], self.weapon.angle, "pistol")
            elif self.current_weapon == "rpg":
                explosion_sound.play()
                return RPGBullet(bullet_pos[0], bullet_pos[1], self.weapon.angle)
            elif self.current_weapon == "sniper":
                boom_sound.play()
                return Bullet(bullet_pos[0], bullet_pos[1], self.weapon.angle, "sniper")
        elif self.bullets_in_magazine == 0 and not self.reloading:
            if (self.current_weapon == "pistol" and self.magazines > 0) or \
                    (self.current_weapon == "minigun" and self.minigun_ammo > 0) or \
                    (self.current_weapon == "sniper" and self.sniper_ammo > 0) or \
                    (self.current_weapon == "rpg" and self.rpg_ammo > 0):
                self.reload()
        return None

    def reload(self):
        if not self.reloading:
            if self.current_weapon == "pistol" and self.magazines > 0:
                self.magazines -= 1
            elif self.current_weapon == "minigun" and self.minigun_ammo > 0:
                self.minigun_ammo -= 1
            elif self.current_weapon == "sniper" and self.sniper_ammo > 0:
                self.sniper_ammo -= 1
            elif self.current_weapon == "rpg" and self.rpg_ammo > 0:
                self.rpg_ammo -= 1
            else:
                return False
            self.reloading = True
            self.reload_start_time = pg.time.get_ticks()
            reload_sound.play()
            return True
        return False

    def buy_magazines(self):
        weapon_costs = {
            "pistol": (50, 3),  # 50 монет, +2 магазина
            "minigun": (50, 2),  # 150 монет, +1 лента (50 патронов)
            "sniper": (50, 2),  # 100 монет, +2 обоймы (6 патронов)
            "rpg": (50, 1)  # 200 монет, +1 ракета
        }

        cost, amount = weapon_costs.get(self.current_weapon, (100, 1))

        if self.coins >= cost:
            if self.current_weapon == "pistol":
                self.magazines += amount
            elif self.current_weapon == "minigun":
                self.minigun_ammo += amount
            elif self.current_weapon == "sniper":
                self.sniper_ammo += amount
            elif self.current_weapon == "rpg":
                self.rpg_ammo += amount
            self.coins -= cost
            return True
        return False

    def buy_weapon(self, weapon_type, cost):
        if self.coins >= cost:
            self.coins -= cost
            if weapon_type == "rpg":
                self.rpg_ammo += 2
                self.switch_weapon("rpg")
                return True
            elif weapon_type == "minigun":
                self.minigun_ammo += 2
                self.switch_weapon("minigun")
                return True
            elif weapon_type == "sniper":
                self.sniper_ammo += 4
                self.switch_weapon("sniper")
                return True
        return False

    def switch_weapon(self, weapon_type):
        if hasattr(self, 'weapon'):
            self.weapon.kill()
            if self.weapon in self.all_sprites:
                self.all_sprites.remove(self.weapon)

        self.current_weapon = weapon_type
        self.weapon = Weapon(self, weapon_type, self.all_sprites)

        if weapon_type == "pistol":
            self.bullets_in_magazine = 10
        elif weapon_type == "rpg":
            self.bullets_in_magazine = 1
        elif weapon_type == "minigun":
            self.bullets_in_magazine = 50
        elif weapon_type == "sniper":
            self.bullets_in_magazine = 3

        if self.all_sprites:
            self.all_sprites.add(self.weapon)

    def handle_event(self, event):
        if event.type == MOUSEBUTTONDOWN and event.button == 1:
            if self.current_weapon == "minigun":
                self.minigun_firing = True
            bullet = self.shoot()
            return bullet
        elif event.type == MOUSEBUTTONUP and event.button == 1:
            if self.current_weapon == "minigun":
                self.minigun_firing = False
        return None

    def draw(self, surface):
        surface.blit(self.image, self.rect)
        self.weapon.draw(surface)

    def update_duel(self, keys, is_player1):
        """Метод для обновления позиции игрока в дуэльном режиме"""
        if is_player1:
            # Управление для первого игрока (WASD)
            if keys[K_w] and self.rect.top > 0:
                self.rect.y -= self.speed
            if keys[K_s] and self.rect.bottom < HEIGHT:
                self.rect.y += self.speed
            if keys[K_a] and self.rect.left > 0:
                self.rect.x -= self.speed
            if keys[K_d] and self.rect.right < WIDTH // 2:
                self.rect.x += self.speed
        else:
            # Управление для второго игрока (стрелочки)
            if keys[K_UP] and self.rect.top > 0:
                self.rect.y -= self.speed
            if keys[K_DOWN] and self.rect.bottom < HEIGHT:
                self.rect.y += self.speed
            if keys[K_LEFT] and self.rect.left > WIDTH // 2:
                self.rect.x -= self.speed
            if keys[K_RIGHT] and self.rect.right < WIDTH:
                self.rect.x += self.speed


class ShopMenu:
    def __init__(self):
        self.visible = False
        self.background = pg.Surface((600, 400))
        self.background.fill((50, 50, 50))
        self.background.set_alpha(230)
        self.rect = self.background.get_rect(center=(WIDTH // 2, HEIGHT // 2))

        self.rpg_button = Button(pg.Surface((180, 200)), (self.rect.x + 30, self.rect.y + 100), font_size=24)
        self.minigun_button = Button(pg.Surface((180, 200)), (self.rect.x + 230, self.rect.y + 100), font_size=24)
        self.sniper_button = Button(pg.Surface((180, 200)), (self.rect.x + 430, self.rect.y + 100), font_size=24)
        self.close_button = Button(pg.Surface((100, 40)), (self.rect.x + 250, self.rect.y + 350), "Закрыть",
                                   font_size=24)

    def draw(self, surface, player):
        if self.visible:
            surface.blit(self.background, self.rect)
            font = pg.font.SysFont(None, 48)
            title = font.render("Магазин оружия", True, WHITE)
            surface.blit(title, (self.rect.x + 200, self.rect.y + 30))
            coins_text = font.render(f"Монеты: {player.coins}", True, YELLOW)
            surface.blit(coins_text, (self.rect.x + 220, self.rect.y + 70))
            self.rpg_button.draw(surface)
            self.minigun_button.draw(surface)
            self.sniper_button.draw(surface)
            self.close_button.draw(surface)

            small_font = pg.font.SysFont(None, 24)
            rpg_desc = [
                "Ракетница:",
                "- Взрыв при попадании",
                "- Поражает все цели",
                "- Магазин: 1 патрон",
                "- Стоимость: 500"
            ]
            for i, line in enumerate(rpg_desc):
                text = small_font.render(line, True, WHITE)
                surface.blit(text, (self.rpg_button.rect.x, self.rpg_button.rect.y + 40 + i * 20))

            minigun_desc = [
                "Миниган:",
                "- Автом.стрельба",
                "- Большой магазин (50)",
                "- Стоимость: 600"
            ]
            for i, line in enumerate(minigun_desc):
                text = small_font.render(line, True, WHITE)
                surface.blit(text, (self.minigun_button.rect.x, self.minigun_button.rect.y + 40 + i * 20))

            sniper_desc = [
                "Снайперская винтовка:",
                "- Мощный выстрел",
                "- Магазин: 3 патрона",
                "- Моментальное попадание",
                "- Стоимость: 200"
            ]
            for i, line in enumerate(sniper_desc):
                text = small_font.render(line, True, WHITE)
                surface.blit(text, (self.sniper_button.rect.x, self.sniper_button.rect.y + 40 + i * 20))

    def handle_event(self, event, player):
        if event.type == MOUSEBUTTONDOWN and event.button == 1:
            if self.rpg_button.is_clicked(event.pos):
                if player.buy_weapon("rpg", 0):
                    player.switch_weapon("rpg")
            elif self.minigun_button.is_clicked(event.pos):
                if player.buy_weapon("minigun", 0):
                    player.switch_weapon("minigun")
            elif self.sniper_button.is_clicked(event.pos):
                if player.buy_weapon("sniper", 0):
                    player.switch_weapon("sniper")
            elif self.close_button.is_clicked(event.pos):
                self.visible = False


class MainMenu:
    def __init__(self):
        self.background = pg.Surface((WIDTH, HEIGHT))
        self.background.fill((30, 30, 50))

        self.level1_button = Button(pg.Surface((300, 60)), (WIDTH // 2 - 150, HEIGHT // 2 - 100), "Уровень 1: Тир")
        self.level2_button = Button(pg.Surface((300, 60)), (WIDTH // 2 - 150, HEIGHT // 2), "Уровень 2: Тренировка")
        self.shop_button = Button(pg.Surface((300, 60)), (WIDTH // 2 - 150, HEIGHT // 2 + 100), "Магазин")
        self.duel_button = Button(pg.Surface((300, 60)), (WIDTH // 2 - 150, HEIGHT // 2 + 200), "Дуэль")

        self.font = pg.font.SysFont(None, 72)
        self.title = self.font.render("Тир", True, WHITE)
        self.title_rect = self.title.get_rect(center=(WIDTH // 2, HEIGHT // 4))

    def draw(self, surface):
        surface.blit(self.background, (0, 0))
        surface.blit(self.title, self.title_rect)
        self.level1_button.draw(surface)
        self.level2_button.draw(surface)
        self.shop_button.draw(surface)
        self.duel_button.draw(surface)

    def handle_event(self, event):
        if event.type == MOUSEBUTTONDOWN and event.button == 1:
            if self.level1_button.is_clicked(event.pos):
                return LEVEL1
            elif self.level2_button.is_clicked(event.pos):
                return LEVEL2
            elif self.shop_button.is_clicked(event.pos):
                return SHOP
            elif self.duel_button.is_clicked(event.pos):
                return DUEL
        return MENU


def draw_ui(surface, player, score):
    font = pg.font.SysFont(None, 36)
    score_text = font.render(f"Счёт: {score}", True, WHITE)
    surface.blit(score_text, (10, 10))

    coins_text = font.render(f"Монеты: {player.coins}", True, WHITE)
    surface.blit(coins_text, (10, 50))

    if player.current_weapon == "pistol":
        weapon_text = font.render(f"Патроны: {player.bullets_in_magazine}/10", True, WHITE)
        magazines_text = font.render(f"Магазины: {player.magazines}", True, WHITE)
    elif player.current_weapon == "rpg":
        weapon_text = font.render(f"РПГ: {player.bullets_in_magazine}/1", True, WHITE)
        magazines_text = font.render(f"Ракеты: {player.rpg_ammo}", True, WHITE)
    elif player.current_weapon == "minigun":
        weapon_text = font.render(f"Миниган: {player.bullets_in_magazine}/50", True, WHITE)
        magazines_text = font.render(f"Ленты: {player.minigun_ammo}", True, WHITE)
    elif player.current_weapon == "sniper":
        weapon_text = font.render(f"Винтовка: {player.bullets_in_magazine}/3", True, WHITE)
        magazines_text = font.render(f"Обоймы: {player.sniper_ammo}", True, WHITE)

    surface.blit(weapon_text, (10, 90))
    surface.blit(magazines_text, (10, 130))

    if player.reloading:
        current_time = pg.time.get_ticks()
        elapsed = current_time - player.reload_start_time
        reload_percentage = min(elapsed / RELOAD_TIME, 1.0)

        pg.draw.rect(surface, GRAY, (10, 170, 200, 20))
        pg.draw.rect(surface, GREEN, (10, 170, 200 * reload_percentage, 20))

        reload_font = pg.font.SysFont(None, 24)
        reload_text = reload_font.render("Перезарядка", True, WHITE)
        reload_text_rect = reload_text.get_rect(center=(110, 180))
        surface.blit(reload_text, reload_text_rect)


class Barrier(pg.sprite.Sprite):
    def __init__(self):
        super().__init__()
        self.image = barrier_img
        self.rect = self.image.get_rect()
        self.rect.x = int(WIDTH * 0.3)
        self.rect.y = 0
        self.rect.height = HEIGHT


def game_level1(initial_coins=0):
    global global_coins, game_state
    all_sprites = pg.sprite.Group()
    bullets = pg.sprite.Group()
    targets = pg.sprite.Group()

    player = Player(initial_coins, all_sprites)
    all_sprites.add(player)
    all_sprites.add(player.weapon)

    barrier = Barrier()
    player.barrier = barrier
    all_sprites.add(barrier)

    buy_button = Button(buy_button_img, (WIDTH - 110, 10))
    shop_button = Button(shop_img, (WIDTH - 110, 60))

    for _ in range(10):
        target = Target(level=1)
        all_sprites.add(target)
        targets.add(target)

    score = 0
    shop_menu = ShopMenu()
    game_over = False
    lose_time = 0
    lose_font = pg.font.SysFont(None, 72)

    running = True
    while running:
        for event in pg.event.get():
            if event.type == QUIT:
                running = False
                pg.quit()
                sys.exit()
            elif event.type == MOUSEBUTTONDOWN:
                if event.button == 1:
                    bullet = player.handle_event(event)
                    if bullet:
                        all_sprites.add(bullet)
                        bullets.add(bullet)
                    if shop_menu.visible:
                        shop_menu.handle_event(event, player)
                    else:
                        if buy_button.is_clicked(event.pos):
                            player.buy_magazines()
                        elif shop_button.is_clicked(event.pos):
                            shop_menu.visible = True
            elif event.type == MOUSEBUTTONUP:
                if event.button == 1:
                    player.handle_event(event)
            elif event.type == KEYDOWN:
                if event.key == K_ESCAPE:
                    global_coins = player.coins
                    game_state = MENU
                    return

        # Автоматическая стрельба для минигана
        if player.current_weapon == "minigun" and player.minigun_firing:
            bullet = player.update()
            if bullet:
                all_sprites.add(bullet)
                bullets.add(bullet)

        all_sprites.update()

        # Проверка столкновений пуль с мишенями
        for bullet in bullets.sprites():
            targets_hit = pg.sprite.spritecollide(bullet, targets, False, pg.sprite.collide_mask)
            for target in targets_hit:
                if target.hit(bullet.damage):
                    score += 10
                    player.coins += 10
                    target.kill()
                bullet.kill()
                break

        # Проверка условий проигрыша
        if not game_over:
            if (player.bullets_in_magazine == 0 and not player.reloading and
                    ((player.current_weapon == "pistol" and player.magazines == 0) or
                     (player.current_weapon == "minigun" and player.minigun_ammo == 0) or
                     (player.current_weapon == "sniper" and player.sniper_ammo == 0) or
                     (player.current_weapon == "rpg" and player.rpg_ammo == 0)) and
                    player.coins < 50):
                game_over = True
                lose_time = pg.time.get_ticks()

        # Генерация новых мишеней
        if len(targets) == 0:
            for _ in range(10):
                target = Target(level=1)
                all_sprites.add(target)
                targets.add(target)

        # Отрисовка
        screen.blit(background_img, (0, 0))
        all_sprites.draw(screen)
        buy_button.draw(screen)
        shop_button.draw(screen)
        draw_ui(screen, player, score)
        shop_menu.draw(screen, player)

        if game_over:
            lose_text = lose_font.render("You lose", True, RED)
            screen.blit(lose_text, (WIDTH // 2 - lose_text.get_width() // 2,
                                    HEIGHT // 2 - lose_text.get_height() // 2))
            if pg.time.get_ticks() - lose_time > 3000:
                global_coins = player.coins
                game_state = MENU
                return

        pg.display.flip()
        clock.tick(60)


def game_level2(initial_coins=0):
    global global_coins, game_state
    all_sprites = pg.sprite.Group()
    bullets = pg.sprite.Group()
    targets = pg.sprite.Group()

    player = Player(initial_coins, all_sprites)
    player.switch_weapon("sniper")
    player.bullets_in_magazine = 9999
    player.sniper_ammo = 9999
    player.reloading = False

    all_sprites.add(player)
    all_sprites.add(player.weapon)

    barrier = Barrier()
    player.barrier = barrier
    all_sprites.add(barrier)

    score = 0
    last_target_time = pg.time.get_ticks()
    target_spawn_delay = 1500

    running = True
    while running:
        current_time = pg.time.get_ticks()

        for event in pg.event.get():
            if event.type == QUIT:
                running = False
                pg.quit()
                sys.exit()
            elif event.type == MOUSEBUTTONDOWN:
                if event.button == 1:
                    bullet = Bullet(
                        *player.weapon.get_muzzle_position(),
                        player.weapon.angle,
                        "sniper"
                    )
                    boom_sound.play()
                    all_sprites.add(bullet)
                    bullets.add(bullet)
            elif event.type == KEYDOWN:
                if event.key == K_ESCAPE:
                    global_coins = player.coins
                    game_state = MENU
                    return

        if current_time - last_target_time > target_spawn_delay and len(targets) < 5:
            target = Target(level=2)
            all_sprites.add(target)
            targets.add(target)
            last_target_time = current_time

        all_sprites.update()

        # Проверка столкновений пуль с мишенями
        for bullet in bullets.sprites():
            targets_hit = pg.sprite.spritecollide(bullet, targets, False, pg.sprite.collide_mask)
            for target in targets_hit:
                if target.hit(bullet.damage):
                    score += 10
                    player.coins += 10
                    target.kill()
                bullet.kill()
                break

        screen.blit(background_img, (0, 0))
        all_sprites.draw(screen)
        draw_ui(screen, player, score)
        pg.display.flip()
        clock.tick(60)


def shop_screen(initial_coins=0):
    global global_coins, game_state
    all_sprites = pg.sprite.Group()
    player = Player(initial_coins, all_sprites)
    shop_menu = ShopMenu()
    shop_menu.visible = True

    running = True
    while running:
        for event in pg.event.get():
            if event.type == QUIT:
                running = False
                pg.quit()
                sys.exit()
            elif event.type == MOUSEBUTTONDOWN:
                if event.button == 1:
                    shop_menu.handle_event(event, player)
            elif event.type == KEYDOWN:
                if event.key == K_ESCAPE:
                    global_coins = player.coins
                    game_state = MENU
                    return

        screen.fill((30, 30, 50))
        all_sprites.update()
        all_sprites.draw(screen)
        shop_menu.draw(screen, player)

        font = pg.font.SysFont(None, 36)
        back_text = font.render("Нажмите ESC для возврата", True, WHITE)
        screen.blit(back_text, (WIDTH // 2 - 150, HEIGHT - 50))

        pg.display.flip()
        clock.tick(60)


def game_duel():
    global game_state
    all_sprites = pg.sprite.Group()
    bullets_p1 = pg.sprite.Group()
    bullets_p2 = pg.sprite.Group()

    player1 = Player(all_sprites=all_sprites)
    player1.rect.center = (200, HEIGHT // 2)
    player1.switch_weapon("pistol")
    player1.speed = 5  # Устанавливаем одинаковую скорость

    player2 = Player(all_sprites=all_sprites)
    player2.rect.center = (600, HEIGHT // 2)
    player2.switch_weapon("pistol")
    player2.speed = 5  # Устанавливаем одинаковую скорость

    all_sprites.add(player1, player2)

    divider = pg.Rect(WIDTH // 2 - 1, 0, 2, HEIGHT)

    running = True
    while running:
        for event in pg.event.get():
            if event.type == QUIT:
                running = False
                pg.quit()
                sys.exit()
            elif event.type == KEYDOWN:
                if event.key == K_ESCAPE:
                    game_state = MENU
                    return
                elif event.key == K_r:  # Перезарядка игрока 1
                    player1.reload()
                elif event.key == K_m:  # Перезарядка игрока 2
                    player2.reload()
                elif event.key == K_SPACE:  # Выстрел игрока 1
                    bullet = player1.shoot()
                    if bullet:
                        bullet.angle = 0  # Пули летят прямо
                        all_sprites.add(bullet)
                        bullets_p1.add(bullet)
                elif event.key == K_RETURN:  # Выстрел игрока 2
                    bullet = player2.shoot()
                    if bullet:
                        bullet.angle = 180  # Пули летят прямо в другую сторону
                        all_sprites.add(bullet)
                        bullets_p2.add(bullet)

        # Управление игроком 1 (WASD)
        keys = pg.key.get_pressed()
        if keys[K_w] and player1.rect.top > 0:
            player1.rect.y -= player1.speed
        if keys[K_s] and player1.rect.bottom < HEIGHT:
            player1.rect.y += player1.speed
        if keys[K_a] and player1.rect.left > 0:
            player1.rect.x -= player1.speed
        if keys[K_d] and player1.rect.right < WIDTH // 2:
            player1.rect.x += player1.speed

        # Управление игроком 2 (стрелочки)
        if keys[K_UP] and player2.rect.top > 0:
            player2.rect.y -= player2.speed
        if keys[K_DOWN] and player2.rect.bottom < HEIGHT:
            player2.rect.y += player2.speed
        if keys[K_LEFT] and player2.rect.left > WIDTH // 2:
            player2.rect.x -= player2.speed
        if keys[K_RIGHT] and player2.rect.right < WIDTH:
            player2.rect.x += player2.speed

        all_sprites.update()

        # Проверка столкновений игроков
        if pg.sprite.collide_rect(player1, player2):
            # Отталкивание при столкновении
            if player1.rect.centerx < player2.rect.centerx:
                player1.rect.x -= 5
                player2.rect.x += 5
            else:
                player1.rect.x += 5
                player2.rect.x -= 5

        # Проверка попаданий пуль игрока 1 в игрока 2
        for bullet in bullets_p1:
            if pg.sprite.collide_mask(bullet, player2):
                player2.kill()
                running = False
            # Удаляем пулю при выходе за границы
            if (bullet.rect.right < 0 or bullet.rect.left > WIDTH or
                    bullet.rect.bottom < 0 or bullet.rect.top > HEIGHT):
                bullet.kill()

        # Проверка попаданий пуль игрока 2 в игрока 1
        for bullet in bullets_p2:
            if pg.sprite.collide_mask(bullet, player1):
                player1.kill()
                running = False
            # Удаляем пулю при выходе за границы
            if (bullet.rect.right < 0 or bullet.rect.left > WIDTH or
                    bullet.rect.bottom < 0 or bullet.rect.top > HEIGHT):
                bullet.kill()

        # Отрисовка
        screen.fill(BLACK)
        pg.draw.rect(screen, WHITE, divider)

        font = pg.font.SysFont(None, 36)
        p1_text = font.render("Игрок 1: WASD + SPACE", True, WHITE)
        p2_text = font.render("Игрок 2: Стрелки + ENTER", True, WHITE)
        reload1_text = font.render("R - перезарядка", True, WHITE)
        reload2_text = font.render("M - перезарядка", True, WHITE)

        screen.blit(p1_text, (10, 10))
        screen.blit(p2_text, (WIDTH - 250, 10))
        screen.blit(reload1_text, (10, 50))
        screen.blit(reload2_text, (WIDTH - 250, 50))

        all_sprites.draw(screen)
        pg.display.flip()
        clock.tick(60)

    game_state = MENU


def main():
    global global_coins, game_state
    main_menu = MainMenu()

    while True:
        if game_state == MENU:
            for event in pg.event.get():
                if event.type == QUIT:
                    pg.quit()
                    sys.exit()
                new_state = main_menu.handle_event(event)
                if new_state != MENU:
                    game_state = new_state
            main_menu.draw(screen)
        elif game_state == LEVEL1:
            game_level1(global_coins)
        elif game_state == LEVEL2:
            game_level2(global_coins)
        elif game_state == SHOP:
            shop_screen(global_coins)
        elif game_state == DUEL:
            game_duel()

        pg.display.flip()
        clock.tick(60)


if __name__ == "__main__":
    main()
